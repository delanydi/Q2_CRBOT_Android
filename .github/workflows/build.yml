name: Build CRBOT for Android

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        abi: [armeabi-v7a, arm64-v8a]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        add-to-path: true
        
    - name: Prepare NDK project structure
      run: |
        echo "Creating proper jni directory structure"
        mkdir -p jni
        
        if [ -f "Android.mk" ]; then
          cp Android.mk jni/
        fi
        
        if [ -f "Application.mk" ]; then
          cp Application.mk jni/
        fi
        
        find . -maxdepth 1 -name "*.c" -exec cp {} jni/ \;
        find . -maxdepth 1 -name "*.h" -exec cp {} jni/ \;
        
    - name: Update Application.mk for newer NDK
      run: |
        cat > jni/Application.mk << 'EOF'
        APP_PLATFORM := android-21
        APP_ABI := armeabi-v7a arm64-v8a
        APP_STL := c++_static
        APP_OPTIM := release
        EOF
        
    - name: Fix CTF compatibility issues
      run: |
        echo "Fixing CTF function pointer issues"
        
        # Fix the function pointer type mismatch in g_items.c
        sed -i 's/CTFDrop_Flag,/NULL, \/\/CTFDrop_Flag disabled for compatibility/g' jni/g_items.c
        
        # Fix the tautological comparison in g_ctf.c
        sed -i 's/if (team1count < team1count)/if (team1count < team2count)/g' jni/g_ctf.c
        
        echo "Applied compatibility fixes"
        
    - name: Build CRBOT for ${{ matrix.abi }}
      run: |
        echo "Building for architecture: ${{ matrix.abi }}"
        $ANDROID_NDK_ROOT/ndk-build APP_ABI=${{ matrix.abi }} -j$(nproc)
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: crbot-${{ matrix.abi }}
        path: libs/${{ matrix.abi }}/libcrbot.so
        retention-days: 30
